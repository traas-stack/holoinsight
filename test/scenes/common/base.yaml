# base services configs for extends

services:
  mysql:
    image: ${mysql_image:-mysql:8}
    environment:
      MYSQL_ROOT_PASSWORD: holoinsight
      MYSQL_USER: holoinsight
      MYSQL_PASSWORD: holoinsight
      MYSQL_DATABASE: holoinsight
    volumes:
    - ./my.cnf:/etc/mysql/conf.d/my.cnf
    restart: always
    ports:
    - 3306
    healthcheck:
      test: mysql -uholoinsight -pholoinsight -Dholoinsight
      interval: 3s
      retries: 300
      timeout: 10s
  mongo:
    image: ${mongo_image:-mongo:4.4.18}
    environment:
      MONGO_INITDB_ROOT_USERNAME: holoinsight
      MONGO_INITDB_ROOT_PASSWORD: holoinsight
      MONGO_INITDB_DATABASE: holoinsight
    volumes:
    - ./init.js:/docker-entrypoint-initdb.d/init.js
    restart: always
    ports:
    - 27017
    healthcheck:
      test: [ "CMD", "timeout", "1", "bash", "-c", "cat < /dev/null > /dev/tcp/127.0.0.1/27017" ]
      interval: 3s
      retries: 300
      timeout: 10s
  ceresdb:
    image: ${ceresdb_image:-ceresdb/ceresdb-server:v1.0.0}
    volumes:
    - ./ceresdb_entrypoint.sh:/entrypoint.sh
    restart: always
    healthcheck:
      test: [ "CMD", "timeout", "1", "bash", "-c", "cat < /dev/null > /dev/tcp/127.0.0.1/5440" ]
      interval: 3s
      retries: 300
      timeout: 10s
    ports:
    - 8831
    - 5440
  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    restart: always
    ports:
      - 9090
  server:
    image: ${server_image:-holoinsight/server:latest}
    environment:
      JAVA_APP_OPTS: "-Xmx1024m -Xms1024m -Xmn512m"
      JAVA_DEBUG_OPTS: ${JAVA_DEBUG_OPTS:-}
    healthcheck:
      test: [ "CMD", "bash", "/home/admin/bin/health.sh" ]
      interval: 3s
      retries: 300
      timeout: 10s
    ports:
    - 80 # nginx
    - 8080 # tomcat
    - 8000 # java debug
    - 11800 # trace
  collector:
    image: ${collector_image:-holoinsight/otelcontribcol:latest}
    healthcheck:
      test: [ "CMD", "timeout", "1", "bash", "-c", "cat < /dev/null > /dev/tcp/127.0.0.1/11800" ]
      interval: 3s
      retries: 300
      timeout: 10s
    ports:
      - 11800 # skywalking
    volumes:
    - ./collector-config.yml:/config/config.yml
  agent-image:
    image: ${server_image:-holoinsight/agent:latest}
    entrypoint: [ "true" ]
  mysql-data-init:
    image: ${mysql_image:-mysql:8}
    restart: "no"
    volumes:
    - ./my.cnf:/etc/mysql/conf.d/my.cnf
    - ./init-db.sh:/init-db.sh
    - ./exec-sql-script.sh:/exec-sql-script.sh
    - ../../../server/extension/extension-common-flyway/src/main/resources/db/migration:/sql/0migration
    working_dir: /
    entrypoint:
    - /init-db.sh
  es:
    image: ${es_image:-elasticsearch:7.16.1}
    environment:
      "discovery.type": "single-node"
      ES_JAVA_OPTS: -Xms1g -Xmx1g
    ports:
    - 9200
    - 9300
    healthcheck:
      test: [ "CMD", "timeout", "1", "bash", "-c", "cat < /dev/null > /dev/tcp/127.0.0.1/9200" ]
      interval: 1s
      retries: 300
      timeout: 10s
  kibana:
    image: ${kibana_image:-kibana:7.16.1}
    environment:
      ELASTICSEARCH_HOSTS: 'http://es:9200'
