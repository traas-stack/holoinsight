services:
  mysql:
    extends:
      file: ../common/base.yaml
      service: mysql
  phpmyadmin:
    extends:
      file: ../common/base.yaml
      service: phpmyadmin
  mongo:
    extends:
      file: ../common/base.yaml
      service: mongo
  mongo-express:
    extends:
      file: ../common/base.yaml
      service: mongo-express
    depends_on:
      mongo:
        condition: service_healthy
  ceresdb:
    extends:
      file: ../common/base.yaml
      service: ceresdb
  prometheus:
    extends:
      file: ../common/base.yaml
      service: prometheus
    depends_on:
      ceresdb:
        condition: service_healthy
  es:
    extends:
      file: ../common/base.yaml
      service: es
  mysql-data-init:
    extends:
      file: ../common/base.yaml
      service: mysql-data-init
    depends_on:
      mysql:
        condition: service_healthy
    volumes:
    - ./data.sql:/sql/1data/V999999__data.sql
  server:
    extends:
      file: ../common/base.yaml
      service: server
    depends_on:
      mysql-data-init:
        condition: service_completed_successfully
      mongo:
        condition: service_healthy
      ceresdb:
        condition: service_healthy
      es:
        condition: service_healthy
    volumes:
    - ./application.yaml:/home/admin/application.yaml
  collector:
    extends:
      file: ../common/base.yaml
      service: collector
    depends_on:
      server:
        condition: service_healthy
  agent-image:
    image: ${agent_image:-holoinsight/agent:latest}
    entrypoint: [ "true" ]
  finish:
    image: busybox:1.35
    depends_on:
      server:
        condition: service_healthy
      collector:
        condition: service_healthy
      agent-image:
        condition: service_completed_successfully
    entrypoint: [ "true" ]
